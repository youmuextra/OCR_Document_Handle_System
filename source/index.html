<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¿åŠ¡å…¬æ–‡æ™ºèƒ½ç®¡ç†å¹³å°</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        body { background-color: #f5f7fa; margin: 0; font-family: "Helvetica Neue",Helvetica,"PingFang SC",Arial,sans-serif; }
        .header { background-color: #409EFF; color: white; padding: 15px 20px; font-size: 20px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { padding: 20px; max-width: 1200px; margin: 0 auto; }
        .stats-card { text-align: center; padding: 20px; }
        .stats-num { font-size: 24px; font-weight: bold; color: #409EFF; margin-top: 10px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; }
        .mt-20 { margin-top: 20px; }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <span>ğŸ›ï¸ æ”¿åŠ¡å…¬æ–‡æ™ºèƒ½ç®¡ç†å¹³å°</span>
            <el-button type="success" @click="handleSimulateCapture" :loading="capturing">ğŸ“¸ æ¨¡æ‹ŸæŠ“æ‹å½•å…¥</el-button>
        </div>

        <div class="container">
            <el-row :gutter="20">
                <el-col :span="6" v-for="(val, label) in statsMap" :key="label">
                    <el-card shadow="hover" class="stats-card">
                        <div>{{ label }}</div>
                        <div class="stats-num">{{ val }}</div>
                    </el-card>
                </el-col>
            </el-row>

            <el-card class="mt-20">
                <template #header>
                    <div class="card-header">
                        <span>ğŸ“„ å…¬æ–‡æµè½¬åˆ—è¡¨</span>
                        <el-button type="primary" link @click="fetchData">ğŸ”„ åˆ·æ–°æ•°æ®</el-button>
                    </div>
                </template>
                
                <el-table :data="docList" stripe style="width: 100%" v-loading="loading">
                    <el-table-column prop="id" label="ID" width="70"></el-table-column>
                    <el-table-column prop="title" label="æ ‡é¢˜" show-overflow-tooltip></el-table-column>
                    <el-table-column prop="doc_num" label="å­—å·" width="180"></el-table-column>
                    <el-table-column prop="doc_date" label="å‘æ–‡æ—¥æœŸ" width="150"></el-table-column>
                    <el-table-column prop="status" label="çŠ¶æ€" width="100">
                        <template #default="scope">
                            <el-tag :type="scope.row.status === 'å·²ç­¾æ”¶' ? 'success' : 'warning'">
                                {{ scope.row.status }}
                            </el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column label="æ“ä½œ" width="150">
                        <template #default="scope">
                            <el-button 
                                v-if="scope.row.status === 'å¾…ç­¾æ”¶'" 
                                size="small" 
                                type="primary" 
                                @click="handleSign(scope.row.id)"
                            >ç¡®è®¤ç­¾æ”¶</el-button>
                            <el-button size="small" @click="showDetail(scope.row)">è¯¦æƒ…</el-button>
                        </template>
                    </el-table-column>
                </el-table>
            </el-card>
        </div>

        <el-dialog v-model="detailVisible" title="å…¬æ–‡è¯¦æƒ…" width="50%">
            <div v-if="currentDoc">
                <p><strong>æ ‡é¢˜ï¼š</strong> {{ currentDoc.title }}</p>
                <p><strong>å…¨æ–‡å†…å®¹ï¼š</strong></p>
                <el-input type="textarea" :rows="10" v-model="currentDoc.raw_content" readonly></el-input>
            </div>
        </el-dialog>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;
        const { ElMessage } = ElementPlus;

        createApp({
            setup() {
                const docList = ref([]);
                const statsMap = ref({ "æ€»æ•°": 0, "å¾…ç­¾æ”¶": 0, "å·²ç­¾æ”¶": 0, "ç­¾æ”¶ç‡": "0%" });
                const loading = ref(false);
                const capturing = ref(false);
                const detailVisible = ref(false);
                const currentDoc = ref(null);

                const API_BASE = "http://127.0.0.1:5000/api/v1";

                // è·å–æ‰€æœ‰æ•°æ®
                const fetchData = async () => {
                    loading.ref = true;
                    try {
                        const [listRes, statsRes] = await Promise.all([
                            axios.get(`${API_BASE}/documents`),
                            axios.get(`${API_BASE}/stats`)
                        ]);
                        docList.value = listRes.data.data;
                        const s = statsRes.data.data;
                        statsMap.value = {
                            "æ€»æ•°": s.total_count,
                            "å¾…ç­¾æ”¶": s.pending_count,
                            "å·²ç­¾æ”¶": s.signed_count,
                            "ç­¾æ”¶ç‡": s.completion_rate
                        };
                    } catch (err) {
                        ElMessage.error("è·å–æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦å¯åŠ¨");
                    } finally {
                        loading.value = false;
                    }
                };

                // æ¨¡æ‹ŸæŠ“æ‹
                const handleSimulateCapture = async () => {
                    capturing.value = true;
                    try {
                        const res = await axios.post(`${API_BASE}/simulate_capture`);
                        ElMessage.success("æŠ“æ‹å¹¶è¯†åˆ«æˆåŠŸï¼");
                        fetchData();
                    } catch (err) {
                        ElMessage.error("æ¨¡æ‹ŸæŠ“æ‹å¤±è´¥ï¼š" + (err.response?.data?.detail || "æœªçŸ¥é”™è¯¯"));
                    } finally {
                        capturing.value = false;
                    }
                };

                // ç­¾æ”¶æ“ä½œ
                const handleSign = async (id) => {
                    try {
                        await axios.post(`${API_BASE}/documents/${id}/sign`);
                        ElMessage.success("ç­¾æ”¶æˆåŠŸ");
                        fetchData();
                    } catch (err) {
                        ElMessage.error("ç­¾æ”¶å¤±è´¥");
                    }
                };

                const showDetail = (doc) => {
                    currentDoc.value = doc;
                    detailVisible.value = true;
                };

                onMounted(fetchData);

                return { docList, statsMap, loading, capturing, detailVisible, currentDoc, fetchData, handleSimulateCapture, handleSign, showDetail };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>